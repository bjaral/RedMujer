<h2>Editar emprendimiento</h2>

<div class="card">
  <form class="formulario" [formGroup]="formulario" (ngSubmit)="onSubmit()" enctype="multipart/form-data">

    <div class="form-col-left">
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>RUT</mat-label>
        <input matInput formControlName="rut" required>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" required>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Descripción</mat-label>
        <textarea matInput formControlName="descripcion"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Modalidad</mat-label>
        <mat-select formControlName="modalidad">
          <mat-option value="Presencial">Presencial</mat-option>
          <mat-option value="Online">Online</mat-option>
          <mat-option value="PresencialYOnline">Híbrida</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Horario de Atención</mat-label>
        <textarea matInput formControlName="horario_Atencion"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Categorías</mat-label>
        <mat-select formControlName="categorias" multiple>
          <mat-option *ngFor="let categoria of categorias" [value]="categoria.id_Categoria">
            {{ categoria.nombre }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <div class="contactos-section">
        <h3>Contactos</h3>
        <div formArrayName="contactos">
          <div *ngFor="let contacto of contactos.controls; let i = index" [formGroupName]="i" class="contacto-group">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Tipo de Contacto</mat-label>
              <mat-select formControlName="tipo_Contacto">
                <mat-option *ngFor="let tipo of tiposContacto" [value]="tipo">
                  {{ tipo }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Valor</mat-label>
              <input matInput formControlName="valor" placeholder="Ej: +56912345678">
            </mat-form-field>

            <button type="button" mat-icon-button color="warn" (click)="eliminarContacto(i)" *ngIf="contactos.length > 1">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
        <button type="button" mat-stroked-button color="primary" (click)="agregarContacto()">
          <mat-icon>add</mat-icon> Agregar Contacto
        </button>
      </div>

      <div class="plataformas-section">
        <h3>Plataformas</h3>
        <div formArrayName="plataformas">
          <div *ngFor="let plataforma of plataformas.controls; let i = index" [formGroupName]="i" class="plataforma-group">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Tipo de Plataforma</mat-label>
              <mat-select formControlName="tipo_Plataforma">
                <mat-option *ngFor="let tipo of tiposPlataforma" [value]="tipo.value">
                  {{ tipo.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field" *ngIf="esTipoRedSocial(i)">
              <mat-label>Red Social</mat-label>
              <mat-select formControlName="descripcion">
                <mat-option *ngFor="let red of redesSociales" [value]="red">
                  {{ red }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field" *ngIf="!esTipoRedSocial(i)">
              <mat-label>Descripción</mat-label>
              <input matInput formControlName="descripcion" placeholder="Descripción de la plataforma">
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>URL/Enlace</mat-label>
              <input matInput formControlName="ruta" placeholder="https://...">
            </mat-form-field>

            <button type="button" mat-icon-button color="warn" (click)="eliminarPlataforma(i)" *ngIf="plataformas.length > 1">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
        <button type="button" mat-stroked-button color="primary" (click)="agregarPlataforma()">
          <mat-icon>add</mat-icon> Agregar Plataforma
        </button>
      </div>
      
    </div>

    <div class="form-col-right">
      <div class="image-upload" (click)="uploadInput.click()">
        <mat-icon>upload</mat-icon>
        <span class="image-text">Subir imagen principal</span>
        <input #uploadInput type="file" (change)="onFileSelected($event)" accept="image/*" hidden aria-label="Subir imagen principal">
      </div>

      <div class="preview-container" *ngIf="imagenSeleccionada">
        <img [src]="imagenSeleccionada" alt="Vista previa" class="preview" />
        <button type="button" class="remove-btn" (click)="removeImagenPrincipal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="extra-images-upload" [class.disabled]="maximoImagenesExtrasAlcanzado" (click)="!maximoImagenesExtrasAlcanzado && extraUploadInput.click()">
        <mat-icon>collections</mat-icon>
        <span class="image-text">Agregar hasta 5 fotos adicionales</span>
        <small *ngIf="imagenesExtras.length > 0">{{ imagenesExtras.length }}/5 imágenes subidas</small>
        <input #extraUploadInput type="file" multiple accept="image/*" (change)="onExtraImagesSelected($event)" hidden aria-label="Agregar hasta 5 fotos adicionales"/>
      </div>

      <div class="extra-preview" *ngIf="imagenesExtras.length > 0">
        <div class="mini-preview" *ngFor="let img of imagenesExtras; let i = index">
          <img [src]="img" alt="Imagen adicional {{ i + 1 }}" />
          <button type="button" class="remove-btn" (click)="removeExtraImage(i)">
            <div class="icon-container">
              <mat-icon>close</mat-icon>
            </div>
          </button>
        </div>
      </div>
    </div>

    <button mat-raised-button color="primary" type="submit" [disabled]="formulario.invalid">Guardar</button>
  </form>
</div>