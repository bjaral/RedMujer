<h2>Mi perfil</h2>

<div class="card" *ngIf="!loading">
  <!-- Estadísticas -->
  <div class="stats-section">
    <div class="stat-card">
      <mat-icon>business_center</mat-icon>
      <div class="stat-content">
        <span class="stat-number">{{ totalEmprendimientos }}</span>
        <span class="stat-label">Emprendimientos</span>
      </div>
    </div>
    <div class="stat-card">
      <!-- <mat-icon>calendar_today</mat-icon> -->
      <div class="stat-content">
        <span class="stat-number">Miembro</span>
        <span class="stat-label">Red Mujer USS</span>
      </div>
    </div>
  </div>

  <!-- Botones de acción -->
  <div class="header-actions">
    <button mat-raised-button color="primary" (click)="toggleEditMode()" *ngIf="!editMode">
      <mat-icon>edit</mat-icon> Editar Perfil
    </button>
    <div class="edit-actions" *ngIf="editMode">
      <button mat-raised-button color="primary" (click)="guardarCambios()" [disabled]="perfilForm.invalid">
        <mat-icon>save</mat-icon> Guardar Cambios
      </button>
      <button mat-stroked-button (click)="cancelarEdicion()">
        <mat-icon>cancel</mat-icon> Cancelar
      </button>
    </div>
  </div>

  <form class="formulario" [formGroup]="perfilForm">
    <div class="form-col-left">
      <!-- Datos de Usuario -->
      <div class="section usuario-section">
        <h3>Información de Usuario</h3>
        
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Nombre de usuario</mat-label>
          <input matInput formControlName="username">
          <mat-icon matSuffix>person</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Correo electrónico</mat-label>
          <input matInput formControlName="email" type="email">
          <mat-icon matSuffix>email</mat-icon>
        </mat-form-field>
      </div>

      <!-- Datos Personales -->
      <div class="section personales-section">
        <h3>Datos Personales</h3>
        
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>RUN</mat-label>
          <input matInput formControlName="run">
          <mat-icon matSuffix>badge</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" required>
          <mat-error *ngIf="perfilForm.get('nombre')?.hasError('required') && perfilForm.get('nombre')?.touched">
            El nombre es requerido.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Primer apellido</mat-label>
          <input matInput formControlName="apellido1" required>
          <mat-error *ngIf="perfilForm.get('apellido1')?.hasError('required') && perfilForm.get('apellido1')?.touched">
            El primer apellido es requerido.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Segundo apellido</mat-label>
          <input matInput formControlName="apellido2" required>
          <mat-error *ngIf="perfilForm.get('apellido2')?.hasError('required') && perfilForm.get('apellido2')?.touched">
            El segundo apellido es requerido.
          </mat-error>
        </mat-form-field>
      </div>
    </div>

    <div class="form-col-right">
      <!-- Ubicación -->
      <div class="section ubicacion-section">
        <h3>Ubicación</h3>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Región</mat-label>
          <mat-select formControlName="region" (selectionChange)="onRegionChange()" required>
            <mat-option *ngFor="let region of regiones" [value]="region">
              {{ region.nombre }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>map</mat-icon>
          <mat-error *ngIf="perfilForm.get('region')?.hasError('required') && perfilForm.get('region')?.touched">
            La región es requerida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Comuna</mat-label>
          <mat-select formControlName="comuna" required>
            <mat-option [value]="null" disabled>Seleccione una región primero</mat-option>
            <mat-option *ngFor="let comuna of comunas" [value]="comuna.nombre">
              {{ comuna.nombre }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>location_city</mat-icon>
          <mat-error *ngIf="perfilForm.get('comuna')?.hasError('required') && perfilForm.get('comuna')?.touched">
            La comuna es requerida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Calle</mat-label>
          <input matInput formControlName="calle" required>
          <mat-error *ngIf="perfilForm.get('calle')?.hasError('required') && perfilForm.get('calle')?.touched">
            La calle es requerida.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Número</mat-label>
          <input matInput formControlName="numero" required>
          <mat-error *ngIf="perfilForm.get('numero')?.hasError('required') && perfilForm.get('numero')?.touched">
            El número es requerido.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Referencia adicional</mat-label>
          <input matInput formControlName="referencia">
        </mat-form-field>
      </div>

      <!-- Seguridad -->
      <div class="section seguridad-section">
        <h3>Seguridad</h3>
        
        <button mat-stroked-button type="button" color="primary" (click)="toggleCambiarContrasena()">
          <mat-icon>lock</mat-icon>
          {{ mostrarCambiarContrasena ? 'Cancelar' : 'Cambiar contraseña' }}
        </button>

        <div class="cambiar-contrasena-form" *ngIf="mostrarCambiarContrasena" [formGroup]="cambiarContrasenaForm">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Contraseña actual</mat-label>
            <input matInput type="password" formControlName="contrasenaActual" required>
            <mat-error *ngIf="cambiarContrasenaForm.get('contrasenaActual')?.hasError('required')">
              La contraseña actual es requerida.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Nueva contraseña</mat-label>
            <input matInput type="password" formControlName="contrasenaNueva" required>
            <mat-error *ngIf="cambiarContrasenaForm.get('contrasenaNueva')?.hasError('required')">
              La nueva contraseña es requerida.
            </mat-error>
            <mat-error *ngIf="cambiarContrasenaForm.get('contrasenaNueva')?.hasError('minlength')">
              La contraseña debe tener al menos 6 caracteres.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Confirmar nueva contraseña</mat-label>
            <input matInput type="password" formControlName="confirmarContrasena" required>
            <mat-error *ngIf="cambiarContrasenaForm.hasError('mismatch')">
              Las contraseñas no coinciden.
            </mat-error>
          </mat-form-field>

          <button mat-raised-button color="primary" type="button" (click)="cambiarContrasena()" [disabled]="cambiarContrasenaForm.invalid">
            <mat-icon>save</mat-icon> Guardar nueva contraseña
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="loading-container" *ngIf="loading">
  <mat-spinner></mat-spinner>
  <p>Cargando datos del perfil...</p>
</div>